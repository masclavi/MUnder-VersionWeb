@page
@model MUnder.Pages.Favorites.IndexModel
@using System.Text.Json
@{
    ViewData["Title"] = "Mis Favoritos";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        /* --- tu CSS (puedes pegar exactamente el que usás) --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background-color:#1E1B26; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:white; min-height:100vh; }
        .navbar { background-color:#2D2838; padding:20px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .navbar-brand h1 { color:#9370DB; margin:0; font-size:1.8em; }
        .back-link { color:#9370DB; text-decoration:none; font-size:1.1em; display:flex; align-items:center; gap:8px; transition:opacity .3s; }
        .container { max-width:1200px; margin:40px auto; padding:0 20px; }
        .header-section { background:linear-gradient(135deg,#DC143C 0%,#FF6B6B 100%); padding:40px; border-radius:15px; margin-bottom:40px; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .songs-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:25px; }
        .song-card { background-color:#2D2838; border-radius:12px; overflow:hidden; transition:transform .3s, box-shadow .3s; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
        .song-cover { width:100%; height:280px; object-fit:cover; background-color:#1E1B26; }
        .song-info { padding:20px; }
        .song-title { font-size:1.3em; font-weight:bold; color:#9370DB; margin-bottom:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .song-artist { color:#B8B8B8; font-size:1em; margin-bottom:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .song-actions { display:flex; gap:10px; align-items:center; }
        .btn-favorite { background-color:transparent; border:2px solid #DC143C; color:#DC143C; padding:8px 16px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:.95em; transition:all .3s; flex:1; font-family:inherit; }
        .btn-play { background-color:#9370DB; border:none; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:.95em; transition:all .3s; flex:1; justify-content:center; font-family:inherit; }
        .toast { position:fixed; bottom:30px; right:30px; background-color:#2D2838; color:white; padding:16px 24px; border-radius:10px; border-left:4px solid #9370DB; box-shadow:0 4px 15px rgba(0,0,0,0.4); display:none; z-index:1000; animation:slideIn .3s ease; }
        .toast.show { display:block; }
        @@keyframes slideIn { from { transform:translateX(400px); opacity:0 } to { transform:translateX(0); opacity:1 } }
        @@media (max-width:768px) { .songs-grid { grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px } .navbar { padding:15px 20px } }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()

    <nav class="navbar">
        <div class="navbar-brand"><h1>MUnder</h1></div>
        <a href="/PaginaPrincipal" class="back-link"><span>←</span><span>Volver al inicio</span></a>
    </nav>

    <div class="container">
        <div class="header-section">
            <h2><span>❤️</span> <span>Mis Favoritos</span></h2>
            <p>@Model.FavoriteSongs.Count canción@(Model.FavoriteSongs.Count != 1 ? "es" : "") guardada@(Model.FavoriteSongs.Count != 1 ? "s" : "")</p>
        </div>

        @if (!Model.FavoriteSongs.Any())
        {
            <div class="empty-state">
                <div class="empty-state-icon">💔</div>
                <h3>No tenes favoritos aún</h3>
                <p>Explora la música y marca tus canciones favoritas con el corazón</p>
                <a href="/Songs" class="btn-primary">Explorar Música</a>
            </div>
        }
        else
        {
            <div class="songs-grid">
                @foreach (var song in Model.FavoriteSongs)
                {
                    <div class="song-card" data-song-id="@song.Id">
                        <img src="@song.CoverPath" alt="@song.Title" class="song-cover" onerror="this.src='/Imagenes/default-cover.png'" />
                        <div class="song-info">
                            <div class="song-title">@song.Title</div>
                            <div class="song-artist">@song.Artist</div>
                            <div class="song-actions">
                                <!-- PASO event explícito para evitar usar `event` sin estar definido -->
                                <button class="btn-favorite" onclick="removeFavorite(event, @song.Id)">
                                    <span>💔</span>
                                    <span>Quitar</span>
                                </button>

                                <!-- Uso data-* para evitar problemas de Razor con comillas/escapes -->
                                <button class="btn-play"
                                        data-url="@song.YouTubeUrl"
                                        data-title="@song.Title"
                                        data-artist="@song.Artist"
                                        onclick="playFromButton(this)">
                                    <span>▶️</span>
                                    <span>Reproducir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- Reproductor popup (idéntico al de Songs) ---
        function playFromButton(btn) {
            const youtubeUrl = btn.dataset.url;
            const title = btn.dataset.title || '';
            const artist = btn.dataset.artist || '';

            if (!youtubeUrl || youtubeUrl.trim() === "") {
                alert("No se encontró la URL del video de YouTube.");
                return;
            }

            const embedUrl = getEmbedUrl(youtubeUrl);
            if (!embedUrl) {
                alert("No se pudo generar la URL del video de YouTube.");
                return;
            }

            const width = 900, height = 550;
            const left = (screen.width - width) / 2, top = (screen.height - height) / 2;
            const windowFeatures = 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top + ',menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=no';

            const popup = window.open('', 'YouTubePlayer', windowFeatures);
            if (popup) {
                const escapedTitle = String(title).replace(/'/g, "\\'").replace(/"/g, '\\"');
                const escapedArtist = String(artist).replace(/'/g, "\\'").replace(/"/g, '\\"');

                popup.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${escapedTitle} - ${escapedArtist}</title>
                        <meta charset="utf-8"/>
                        <style>body{margin:0;padding:0;background:#000;overflow:hidden}iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}</style>
                    </head>
                    <body>
                        <iframe src="${embedUrl}?autoplay=1" allowfullscreen></iframe>
                    </body>
                    </html>
                `);
                popup.document.close();
                popup.focus();
            } else {
                alert('Por favor, permite las ventanas emergentes para reproducir el video.');
            }
        }

        function getEmbedUrl(url) {
            if (!url) return '';
            let videoId = '';
            if (url.includes('youtu.be/')) {
                videoId = url.split('/').pop().split('?')[0];
            } else if (url.includes('youtube.com/watch')) {
                try {
                    const urlObj = new URL(url);
                    videoId = urlObj.searchParams.get('v');
                } catch (e) {
                    console.error('Error al parsear la URL de YouTube:', e);
                    return '';
                }
            }
            return videoId ? 'https://www.youtube.com/embed/' + videoId : '';
        }

        // --- Remove favorite: recibe event para manipular el botón con seguridad ---
        async function removeFavorite(evt, songId) {
            evt.preventDefault();
            const button = evt.currentTarget || evt.target;
            if (button) button.disabled = true;

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                const response = await fetch(`/Favorites?handler=RemoveFavorite&songId=${songId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    }
                });

                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    console.log('Resultado:', result);

                    if (result.success && result.isFavorite === false) {
                        const card = document.querySelector('[data-song-id="' + songId + '"]');
                        if (card) {
                            card.style.transition = 'opacity 0.3s, transform 0.3s';
                            card.style.opacity = '0';
                            card.style.transform = 'scale(0.8)';
                            setTimeout(() => {
                                card.remove();
                                const remainingSongs = document.querySelectorAll('.song-card').length;
                                if (remainingSongs === 0) {
                                    location.reload();
                                }
                            }, 300);
                        }
                        showToast('✓ Eliminado de favoritos');
                        return;
                    }

                    // si no success
                    const txt = await response.text().catch(() => '');
                    console.error('No se pudo eliminar:', response.status, txt);
                    showToast('Error al eliminar: ' + response.status);
                } else if (response.status === 401) {
                    alert('Debes iniciar sesión');
                    window.location.href = '/Login';
                } else {
                    const txt = await response.text().catch(() => '');
                    console.error('Error respuesta:', response.status, txt);
                    showToast('Error al eliminar: ' + response.status);
                }
            } catch (err) {
                console.error('Error conexión:', err);
                showToast('Error de conexión');
            } finally {
                if (button) button.disabled = false;
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        console.log('Página de favoritos cargada. Cards:', document.querySelectorAll('.song-card').length);
    </script>
</body>
</html>
